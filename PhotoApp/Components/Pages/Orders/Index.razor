@page "/orders"
@using PhotoApp.Models
@using Microsoft.AspNetCore.Components
@inject AuthService AuthService
@inject DataService DataService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>PhotoApp - Заказы</PageTitle>

<div class="container mt-4">
    <BackButton FallbackUrl="/" />

    <div class="d-flex justify-content-between align-items-center mb-4">
        @if (AuthService.IsClient)
        {
            <h2>Мои заказы</h2>
        }
        else
        {
            <h2>Список заказов</h2>
        }

        @if (AuthService.IsAuthenticated && (AuthService.IsOperator || AuthService.IsAdmin || AuthService.IsClient))
        {
            <a href="/orders/create" class="btn btn-success">
                <i class="oi oi-plus me-2"></i>Создать заказ
            </a>
        }
    </div>

    @if (!AuthService.IsAuthenticated)
    {
        <div class="alert alert-warning text-center">
            <h4>Требуется авторизация</h4>
            <p>Для просмотра заказов необходимо войти в систему.</p>
            <a href="/login" class="btn btn-primary">Войти</a>
        </div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">
                @errorMessage
            </div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success">
                @successMessage
            </div>
        }

        <!-- Фильтры -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Статус</label>
                        <select @bind="selectedStatus" class="form-select">
                            <option value="">Все статусы</option>
                            <option value="принят">Принят</option>
                            <option value="в работе">В работе</option>
                            <option value="готов">Готов</option>
                            <option value="выдан">Выдан</option>
                            <option value="отменен">Отменен</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Дата с</label>
                        <input type="date" @bind="startDate" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Дата по</label>
                        <input type="date" @bind="endDate" class="form-control" />
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary w-100" @onclick="LoadOrders">
                            <i class="oi oi-reload me-2"></i>Обновить
                        </button>
                    </div>
                </div>
            </div>
        </div>

        @if (isLoading)
        {
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p class="mt-2">Загрузка заказов...</p>
            </div>
        }
        else if (orders?.Any() == true)
        {
            <!-- Таблица заказов -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="oi oi-list-rich me-2"></i>
                        @if (AuthService.IsClient)
                        {
                            <text>Мои заказы (@orders.Count)</text>
                        }
                        else
                        {
                            <text>Заказы (@orders.Count)</text>
                        }
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    @if (!AuthService.IsClient)
                                    {
                                        <th>Клиент</th>
                                    }
                                    <th>Дата</th>
                                    <th>Статус</th>
                                    <th>Сумма</th>
                                    <th>Оплата</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var orderItem in orders)
                                {
                                    <tr>
                                        <td>
                                            <strong>#@orderItem.Id</strong>
                                        </td>
                                        @if (!AuthService.IsClient)
                                        {
                                            <td>@orderItem.Client?.FullName</td>
                                        }
                                        <td>@orderItem.CreatedAt.ToString("dd.MM.yyyy HH:mm")</td>
                                        <td>
                                            <span class="badge @GetStatusBadgeClass(orderItem.Status)">
                                                @orderItem.Status
                                            </span>
                                        </td>
                                        <td>
                                            <strong>@orderItem.TotalAmount.ToString("C")</strong>
                                        </td>
                                        <td>
                                            @if (orderItem.IsPaid)
                                            {
                                                <span class="badge bg-success">Оплачен</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning">Не оплачен</span>
                                            }
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary"
                                                        @onclick="() => ShowOrderDetails(orderItem)"
                                                        title="Подробнее">
                                                    <i class="oi oi-eye"></i>
                                                </button>

                                                @if (AuthService.IsOperator || AuthService.IsAdmin)
                                                {
                                                    <button class="btn btn-sm btn-outline-secondary"
                                                            @onclick="() => ChangeOrderStatus(orderItem)"
                                                            title="Изменить статус">
                                                        <i class="oi oi-arrow-thick-right"></i>
                                                    </button>
                                                }

                                                @if (AuthService.IsAdmin)
                                                {
                                                    <button class="btn btn-sm btn-outline-info"
                                                            @onclick="() => EditOrder(orderItem)"
                                                            title="Редактировать">
                                                        <i class="oi oi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-danger"
                                                            @onclick="() => DeleteOrder(orderItem)"
                                                            title="Удалить заказ">
                                                        <i class="oi oi-trash"></i>
                                                    </button>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <i class="oi oi-list-rich display-1 text-muted mb-3"></i>
                @if (AuthService.IsClient)
                {
                    <h4>У вас пока нет заказов</h4>
                    <p class="text-muted">Создайте свой первый заказ!</p>
                }
                else
                {
                    <h4>Заказы не найдены</h4>
                    <p class="text-muted">Нет заказов, соответствующих выбранным фильтрам.</p>
                }
                <a href="/orders/create" class="btn btn-primary">Создать заказ</a>
            </div>
        }

        <!-- Модальное окно деталей заказа -->
        @if (showDetails && selectedOrder != null)
        {
            <div class="modal show d-block" style="background: rgba(0,0,0,0.5)">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Детали заказа #@selectedOrder.Id</h5>
                            <button type="button" class="btn-close" @onclick="CloseDetails"></button>
                        </div>
                        <div class="modal-body">
                            <OrderDetails Order="selectedOrder" />
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseDetails">Закрыть</button>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    private List<Order> orders = new();
    private bool isLoading = false;
    private string selectedStatus = "";
    private DateTime? startDate;
    private DateTime? endDate;
    private bool showDetails = false;
    private Order? selectedOrder = null;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        if (AuthService.IsAuthenticated)
        {
            await LoadOrders();
        }
    }

    private async Task LoadOrders()
    {
        isLoading = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;
        StateHasChanged();

        try
        {
            var allOrders = await DataService.GetOrdersAsync();

            // Для клиентов показываем только их заказы
            if (AuthService.IsClient && AuthService.CurrentClient != null)
            {
                allOrders = allOrders.Where(o => o.ClientId == AuthService.CurrentClient.Id).ToList();
            }

            // Применяем фильтры
            var filteredOrders = allOrders.AsEnumerable();

            if (!string.IsNullOrEmpty(selectedStatus))
            {
                filteredOrders = filteredOrders.Where(o => o.Status == selectedStatus);
            }

            if (startDate.HasValue)
            {
                filteredOrders = filteredOrders.Where(o => o.CreatedAt.Date >= startDate.Value.Date);
            }

            if (endDate.HasValue)
            {
                filteredOrders = filteredOrders.Where(o => o.CreatedAt.Date <= endDate.Value.Date);
            }

            orders = filteredOrders.ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Ошибка загрузки заказов: {ex.Message}";
            Console.WriteLine(errorMessage);
            orders = new List<Order>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ShowOrderDetails(Order order)
    {
        selectedOrder = order;
        showDetails = true;
        StateHasChanged();
    }

    private void CloseDetails()
    {
        showDetails = false;
        selectedOrder = null;
        StateHasChanged();
    }

    private async Task ChangeOrderStatus(Order order)
    {
        try
        {
            // Определяем следующий статус
            var nextStatus = order.Status switch
            {
                "принят" => "в работе",
                "в работе" => "готов",
                "готов" => "выдан",
                "выдан" => "выдан", // конечный статус
                _ => "принят"
            };

            if (nextStatus != order.Status)
            {
                // Временно просто обновляем локально, пока нет метода в DataService
                order.Status = nextStatus;
                successMessage = $"Статус заказа #{order.Id} изменен на '{nextStatus}'";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Ошибка изменения статуса: {ex.Message}";
            Console.WriteLine(errorMessage);
        }
    }

    private void EditOrder(Order order)
    {
        Navigation.NavigateTo($"/orders/edit/{order.Id}");
    }

    private async Task DeleteOrder(Order order)
    {
        if (!await JSRuntime.InvokeAsync<bool>("confirm", $"Вы уверены, что хотите удалить заказ #{order.Id}? Это действие нельзя отменить."))
            return;

        errorMessage = string.Empty;
        successMessage = string.Empty;
        StateHasChanged();

        try
        {
            // Временно просто удаляем из локального списка
            orders.Remove(order);
            successMessage = $"Заказ #{order.Id} успешно удален!";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Ошибка удаления заказа: {ex.Message}";
            Console.WriteLine(errorMessage);
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "принят" => "bg-primary",
            "в работе" => "bg-warning",
            "готов" => "bg-success",
            "выдан" => "bg-info",
            "отменен" => "bg-danger",
            _ => "bg-secondary"
        };
    }
}